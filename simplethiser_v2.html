<!DOCTYPE html>

<html>
<head>
    <title>Simplethiser</title>
    <link rel='stylesheet' href='../css/style.css'>
    <!-- Typekit --> 
    <script src="//use.typekit.net/bin2ptp.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
</head>

<body>
    <h1>Simplethiser <button id='envelopeTrigger'>Trigger</button></h1>
<form>
    <fieldset>
        <legend>Disk operations</legend>
        <button id="savePatch">Save patch</button>
        <input type='text' name='patchName' id='patchName'>
    </fieldset>
    <fieldset>
        <legend>Oscilliscope</legend>
        <div id='oscilliscope'>
            <canvas id='oscilliscopeVisualiser'></canvas>
        </div>
    </fieldset>
    <fieldset id='masterVolume'>
        <legend>Master volume</legend>
        <div class='control-group'>
            <label for='volume'>Volume</label>
            <input type='range' min='0' max='10' step='0.1' value='1' id='volume'>
        </div>
        <div class='control-group'>
            <label for='pan'>Pan</label>
            <input type='range' min='-1' max='1' step='0.01' value='0' id='pan'>
        </div>
    </fieldset>
    <fieldset>
        <legend>Parameter sequencer</legend>    
        <div class='span-4'>
            <div class='control-group'>
                <label for='parameterSelector'>Select parameter</label>
                <select id='parameterSelector'>
                    <option value='filter1.frequency'>Filter cutoff</option>
                    <option value='filter1.Q'>Filter Q</option>
                    <option value='osc2.detune'>Oscillator detune</option>
                </select>
            </div>
        </div>
        <div class='span-4'>
            <div class='control-group'>
                <label for='sequencerIntervalDuration'>Sequencer interval duration</label>
                <input type='number' id='sequencerIntervalDuration' value='1'>
            </div>
        </div>
        <div class='span-4'>
            <div class='control-group'>
                <label for='sequencerStepLength'>Sequencer step length</label>
                <input type='number' id='sequencerStepLength' value='16'>
            </div>
        </div>
        <div class='control-group'>
            <input type='text' data-stepid='1' value='200' length='4' id='parameterValue1'>
            <input type='text' data-stepid='2' value='400' length='4' id='parameterValue2'>
            <input type='text' data-stepid='3' value='200' length='4' id='parameterValue3'>
            <input type='text' data-stepid='4' value='500' length='4' id='parameterValue4'>
            <input type='text' data-stepid='5' value='50' length='4' id='parameterValue5'>
            <input type='text' data-stepid='6' value='800' length='4' id='parameterValue6'>
            <input type='text' data-stepid='7' value='1060' length='4' id='parameterValue7'>
            <input type='text' data-stepid='8' value='200' length='4' id='parameterValue8'>
            <input type='text' data-stepid='9' value='480' length='4' id='parameterValue9'>
            <input type='text' data-stepid='10' value='990' length='4' id='parameterValue10'>
            <input type='text' data-stepid='11' value='440' length='4' id='parameterValue11'>
            <input type='text' data-stepid='12' value='330' length='4' id='parameterValue12'>
            <input type='text' data-stepid='13' value='150' length='4' id='parameterValue13'>
            <input type='text' data-stepid='14' value='650' length='4' id='parameterValue14'>
            <input type='text' data-stepid='15' value='500' length='4' id='parameterValue15'>
            <input type='text' data-stepid='16' value='750' length='4' id='parameterValue16'>
        </div>
    </fieldset>
    <fieldset id='delay' class='fieldset-group'>
        <legend>Dual delay</legend>
        <div class='control-group'>
            <label for='dualEchoUnitBypass'>
                <input type='checkbox' id='dualEchoUnitBypass'>Bypass
            </label>
        </div>
        <div class='span-6'>
            <div class='control-group'>
                <label for='delayTimeLeft'>Delay time left</label>
                <input type='range' min='0' max='10' step='0.1' value='1' id='delayTimeLeft'>
            </div>
            <div class='control-group'>
                <label for='delayFeedbackLeft'>Feedback left</label>
                <input type='range' min='0' max='1' step='0.001' value='0.6' id='delayFeedbackLeft'>
            </div>
            <div class='control-group'>
                <label for='delayLeftWetLevel'>Wet signal left gain</label>
                <input type='range' min='0' max='1' step='0.01' value='1' id='delayLeftWetLevel'>
            </div>
        </div>
        <div class='span-6'>
            <div class='control-group'>
                <label for='delayTimeRight'>Delay time right</label>
                <input type='range' min='0' max='10' step='0.1' value='1' id='delayTimeRight'>
            </div>
            <div class='control-group'>
                <label for='delayFeedbackLeft'>Feedback</label>
                <input type='range' min='0' max='1' step='0.001' value='0.6' id='delayFeedbackRight'>
            </div>
            <div class='control-group'>
                <label for='delayRightWetLevel'>Wet signal right gain</label>
                <input type='range' min='0' max='1' step='0.01' value='1' id='delayRightWetLevel'>
            </div>
        </div>
    </fieldset>
    <fieldset id='dynamics'>
        <legend>Dynamics</legend>
        <div class='control-group'>
            <label for='compressorBypass'>
                <input type='checkbox' id='compressorBypass'>Bypass
            </label>
        </div>
        <div class='control-group'>
            <label for='dynamicsThreshold'>Threshold</label>
            <input type='range' min='-100' max='0' step='0.1' value='-24' id='dynamicsThreshold'>
        </div>
        <div class='control-group'>
            <label for='dynamicsKnee'>Knee</label>
            <input type='range' min='0' max='40' step='1' value='30' id='dynamicsKnee'>
        </div>
        <div class='control-group'>
            <label for='dynamicsRatio'>Ratio</label>
            <input type='range' min='1' max='20' step='0.1' value='12' id='dynamicsRatio'>
        </div>
        <div class='control-group'>
            <label for='dynamicsAttack'>Attack</label>
            <input type='range' min='0' max='1' step='0.001' value='0.003' id='dynamicsAttack'>
        </div>
        <div class='control-group'>
            <label for='dynamicsRelease'>Release</label>
            <input type='range' min='0' max='1' step='0.001' value='0.25' id='dynamicsRelease'>
        </div>
    </fieldset>   
    <fieldset id='vca'>
        <legend>VCA</legend>
        <div class='control-group'>
            <label for='envelopeLevel'>Peak level</label>
            <input type='range' min='-1' max='1' step='0.01' value='1.00' id='envelopeLevel'>
        </div>
        <div class='control-group'>
            <label for='envelopeAttack'>Attack time</label>
            <input type='range' min='0' max='40' step='0.01' value='4.00' id='envelopeAttack'>
        </div>
        <div class='control-group'>
            <label for='envelopeDecay'>Decay time</label>
            <input type='range' min='0.1' max='40' step='0.01' value='4.00' id='envelopeDecay'>
        </div>
        <div class='control-group'>
            <label for='envelopeSustain'>Sustain level</label>
            <input type='range' min='0' max='1' step='0.01' value='0.50' id='envelopeSustain'>
        </div>
        <div class='control-group'>
            <label for='envelopeHold'>Hold time</label>
            <input type='range' min='0' max='40' step='0.01' value='10.0' id='envelopeHold'>
        </div>
        <div class='control-group'>
            <label for='envelopeRelease'>Release time</label>
            <input type='range' min='0' max='40' step='0.01' value='5.0' id='envelopeRelease'>
        </div>
        <div class='control-group'>
            <label for='gain'>Distortion</label>
            <input type='range' min='0' max='8000' step='1' value='800' id='vcaDistortion'>
        </div>
    </fieldset>
    <fieldset id='filter1'>
        <legend>Filter</legend>
        <div class='span-6'>
            <div class='control-group'>
                <label for='filter1frequency'>Filter frequency</label>
                <input type='range' min='1' max='8' step='0.001' value='1.5' id='filter1frequency'>
            </div>
            <div class='control-group'>
                <label for='filter1Q'>Filter Q</label>
                <input type='number' min='0.0001' max='1000' step='0.0001' value='25' id='filter1Q'>
            </div>
            <div class='control-group'>
                <label for='filter1Gain'>Filter gain</label>
                <input type='range' min='-40' max='40' value='0' id='filter1Gain'>
            </div>
            <div class='control-group'>
                <label for='filter1Type'>Filter type</label>
                <select id='filter1Type'>
                    <option value='lowpass'>Low Pass</option>
                    <option value='bandpass' selected>Band Pass</option>
                    <option value='highpass'>High Pass</option>
                    <option value='lowshelf'>Low Shelf</option>
                    <option value='highshelf'>High Shelf</option>
                    <option value='peaking'>Peaking</option>
                    <option value='notch'>Notch</option>
                    <option value='allpass'>All Pass</option>
                </select>
            </div>
        </div>
        <div class='span-6'>
            <div class='control-group'>
                <label for='filter1LfoFrequency'>Filter LFO frequency</label>
                <input type='range' min='0.01' max='8' step='0.01' value='0.01' id='filter1LfoFrequency'>
            </div>
            <div class='control-group'>
                <label for='lfo1Type'>Filter LFO waveform</label>
                <select id='lfo1Type'>
                    <option value='sine'>Sine</option>
                    <option value='square'>Square</option>
                    <option value='sawtooth'>Sawtooth</option>
                    <option value='triangle'>Triangle</option>
                </select>
            </div>
            <div class='control-group'>
                <label for='lfo1Gain'>Filter LFO gain</label>
                <input type='range' min='0' max='100' step='0.1' value='100' id='filter1LfoGain'>
            </div>
        </div>
    </fieldset>
    <fieldset id='oscillators' class='fieldset-group'>
        <legend>Oscillators</legend>
        <div class='control-group'>
            <label for='oscillator1Octave'>Osc1 frequency</label>
            <input type='range' min='1' max='8' step='0.001' value='1.5' id='oscillator1Octave' data-maptostore='oscillator.oscillator1Frequency'>
        </div>
        <div class='control-group'>
            <label for='oscillator2Detune'>Osc2 detune</label>
            <input type='range' min='-100' max='100' value='3' id='oscillator2Detune' data-maptostore='oscillator.oscillator2Detune'>
        </div>
        <div class='control-group'>
            <label for='oscillator2Octave'>Osc2 octave</label>
            <input type='range' min='-2' max='2' step='1' value='-2' id='oscillator2Octave' data-maptostore='oscillator.oscillator2Octave'>
        </div>
        <div class='control-group'>
            <label for='oscillator1Type'>Osc1 waveform</label>
            <select id='oscillator1Type' data-maptostore='oscillator.oscillator1Type'>
                <option value='sine'>Sine</option>
                <option value='square' selected>Square</option>
                <option value='sawtooth'>Sawtooth</option>
                <option value='triangle'>Triangle</option>
            </select>
        </div>
        <div class='control-group'>
            <label for='oscillator2Type'>Osc2 waveform</label>
            <select id='oscillator2Type' data-maptostore='oscillator.oscillator2Type'>
                <option value='sine'>Sine</option>
                <option value='square'>Square</option>
                <option value='sawtooth' selected>Sawtooth</option>
                <option value='triangle'>Triangle</option>
            </select>
        </div>
    </fieldset>
</form>
<script src='../js/require.js' data-main='../js/simplethiser_v2'></script>
<script type='text/javascript'>
    document.querySelector('#savePatch').addEventListener('click', function(event){
        window.localStorage.setItem(document.querySelector('#patchName').value + '_patch', JSON.stringify(window.store.getState()));
    });
    const getStepsArray = function(){
        const inputs = Array.prototype.slice.call(document.querySelectorAll('[id*=parameterValue]'));
        const parameter = window[document.querySelector('#parameterSelector').value.split('.')[0]][document.querySelector('#parameterSelector').value.split('.')[1]];
        const stepsArray = [];
        inputs.map(function(element, index, array){
            stepsArray[parseInt(element.dataset.stepid) - 1] = [{target: parameter, value: parseFloat(element.value)}];    
        });
        return stepsArray.slice(0,document.querySelector('#sequencerStepLength').value);
    } 
    document.querySelector('#oscilliscopeVisualiser').height = '200';
    document.querySelector('#oscilliscopeVisualiser').width = document.querySelector('#oscilliscope').clientWidth;
    document.querySelector('#volume').addEventListener('change', function(event){
        masterVolume.gain.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02)
    });
    document.querySelector('#pan').addEventListener('change', function(event){
        panner.pan.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02)
    });
    document.querySelector('#sequencerStepLength').addEventListener('change', function(event){
        const inputs = Array.prototype.slice.call(document.querySelectorAll('[id*=parameterValue]'));
        inputs.map(function(element, index, array){
            if (Number(element.dataset.stepid) > Number(event.target.value)) {
                element.disabled = 'disable';
            }else{
                element.removeAttribute('disabled');
            }
        });
    });
    document.querySelector('#dualEchoUnitBypass').addEventListener('change', function(event){
        const bypass = event.target.checked;
        dualEchoUnit.bypass(bypass);
    });
    document.querySelector('#delayTimeLeft').addEventListener('change', function(event){
        dualEchoUnit.delayLeft.delayTime.value = event.target.value;
    });
    document.querySelector('#delayTimeRight').addEventListener('change', function(event){
        dualEchoUnit.delayRight.delayTime.value = event.target.value;
    });
    document.querySelector('#delayFeedbackLeft').addEventListener('change', function(event){
        dualEchoUnit.feedbackLeft.gain.value = event.target.value;
    });
    document.querySelector('#delayFeedbackRight').addEventListener('change', function(event){
        dualEchoUnit.feedbackRight.gain.value = event.target.value;
    });
    document.querySelector('#delayRightWetLevel').addEventListener('change', function(event){
        dualEchoUnit.wetChannelRight.gain.value = event.target.value;
    });
    document.querySelector('#delayLeftWetLevel').addEventListener('change', function(event){
        dualEchoUnit.wetChannelLeft.gain.value = event.target.value;
    });
    document.querySelector('#compressorBypass').addEventListener('change', function(event){
        const bypass = event.target.checked;
        compressor.bypass(bypass);
    });    
    document.querySelector('#dynamicsThreshold').addEventListener('change', function(event){
        compressor.compressor.threshold.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02)
    });
    document.querySelector('#dynamicsKnee').addEventListener('change', function(event){
        compressor.compressor.knee.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02)
    });
    document.querySelector('#dynamicsRatio').addEventListener('change', function(event){
        compressor.compressor.ratio.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02)
    });
    document.querySelector('#dynamicsAttack').addEventListener('change', function(event){
        compressor.compressor.attack.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02)
    });
    document.querySelector('#dynamicsRelease').addEventListener('change', function(event){
        compressor.compressor.release.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02)
    });
    document.querySelector('#envelopeTrigger').addEventListener('click', function(event){
        envelope(
            context,
            gainStage.gain,
            0.0,
            parseFloat(document.querySelector('#envelopeLevel').value),
            parseFloat(document.querySelector('#envelopeAttack').value),
            parseFloat(document.querySelector('#envelopeDecay').value),
            parseFloat(document.querySelector('#envelopeSustain').value * document.querySelector('#envelopeLevel').value),
            parseFloat(document.querySelector('#envelopeHold').value),
            parseFloat(document.querySelector('#envelopeRelease').value)
            );
        const envelopeDuration = parseFloat(document.querySelector('#envelopeLevel').value) + 
            parseFloat(document.querySelector('#envelopeAttack').value)+ 
            parseFloat(document.querySelector('#envelopeDecay').value)+
            parseFloat(document.querySelector('#envelopeHold').value)+
            parseFloat(document.querySelector('#envelopeRelease').value);
        runValueSequencer(context, document.querySelector('#sequencerIntervalDuration').value, envelopeDuration, getStepsArray())
    })
    document.querySelector('#vcaDistortion').addEventListener('change', function(event){
        distortion.setCurve(Number(event.target.value));
        setTimeout(drawWaveform, 500);
    });
    document.querySelector('#filter1frequency').addEventListener('change', function(event){
        filter1.frequency.exponentialRampToValueAtTime(Math.pow(2, event.target.value) * 55, context.currentTime + 0.02);
    });
    document.querySelector('#filter1Q').addEventListener('change', function(event){
        filter1.Q.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02);
    });
    document.querySelector('#filter1Gain').addEventListener('change', function(event){
        filter1.gain.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02);
    });
    document.querySelector('#filter1Type').addEventListener('change', function(event){
        filter1.type = event.target.value;
    });
    document.querySelector('#filter1LfoFrequency').addEventListener('change', function(event){
        lfo1.oscillator.frequency.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02);
    });
    document.querySelector('#filter1LfoGain').addEventListener('change', function(event){
        lfo1.gain.gain.exponentialRampToValueAtTime(event.target.value, context.currentTime + 0.02);
    });
    document.querySelector('#lfo1Type').addEventListener('change', function(event){
        lfo1.oscillator.type = event.target.value;
    });
    document.querySelector('#oscillator1Octave').addEventListener('change', function(event){
        window.store.dispatch(window.createUpdateProperty({key: event.target.dataset.maptostore, value: Math.pow(2, event.target.value) * 55}));
        window.store.dispatch(window.createUpdateProperty({key: 'oscillator.oscillator2Frequency', value: (Math.pow(2, event.target.value) * 55) * Math.pow(2, document.querySelector('#oscillator2Octave').value)}));
    });
    document.querySelector('#oscillator2Detune').addEventListener('change', function(event){
        window.store.dispatch(window.createUpdateProperty({key: event.target.dataset.maptostore, value: event.target.value}));
    });
    document.querySelector('#oscillator2Octave').addEventListener('change', function(event){
        window.store.dispatch(window.createUpdateProperty({key: event.target.dataset.maptostore, value: event.target.value}));
        window.store.dispatch(window.createUpdateProperty({key: 'oscillator.oscillator2Frequency', value: (Math.pow(2, document.querySelector('#oscillator1Octave').value) * 55) * Math.pow(2, document.querySelector('#oscillator2Octave').value)}));
    });
    document.querySelector('#oscillator1Type').addEventListener('change', function(event){
        window.store.dispatch(window.createUpdateProperty({key: event.target.dataset.maptostore, value: event.target.value}));
    });
    document.querySelector('#oscillator2Type').addEventListener('change', function(event){
        window.store.dispatch(window.createUpdateProperty({key: event.target.dataset.maptostore, value: event.target.value}));
    });
    document.querySelector('#filter1Type').addEventListener('change', function(event){
        filter1.type = event.target.value;
    });
    document.querySelector('form').addEventListener('submit', function(event){
        event && event.preventDefault()    
    })
</script>
<script>
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-520450-5', 'auto');
    ga('send', 'pageview');

</script>
</body>
</html>
